// src/app/post/create/post_page.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
    Button,
    Card,
    Col,
    ConfigProvider,
    Form,
    Input,
    message,
    Row,
    Select,
    Space,
    Tag,
    theme,
    Typography,
    Upload,
} from 'antd';
import {
    ArrowLeftOutlined,
    BoldOutlined,
    ItalicOutlined,
    LinkOutlined,
    OrderedListOutlined,
    PictureOutlined,
    UnorderedListOutlined,
    UploadOutlined,
} from '@ant-design/icons';
import { ProLayout } from '@ant-design/pro-components';
import { PostsApi, CreatePostRequest } from '@/lib/api/posts';
import { AuthApi } from '@/lib/api/auth';
import Divider from 'antd/es/divider';

const { Title, Text, Paragraph } = Typography;
const { TextArea } = Input;
const { Option } = Select;

export default function CreatePostPage() {
    const router = useRouter();
    const [form] = Form.useForm();
    const [loading, setLoading] = useState(false);
    const [darkMode, setDarkMode] = useState(true);
    const [content, setContent] = useState('');
    const [selectedTags, setSelectedTags] = useState<string[]>([]);
    const [previewMode, setPreviewMode] = useState(false);

    // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    useEffect(() => {
        if (!AuthApi.isAuthenticated()) {
            message.warning('ËØ∑ÂÖàÁôªÂΩï');
            router.push('/login');
        }
    }, []);

    // Ê∏∏ÊàèÂàÜÁ±ª
    const categories = [
        'Ê∏∏ÊàèËÆ®ËÆ∫',
        'ÊîªÁï•ÂàÜ‰∫´',
        'Ê∏∏ÊàèËØÑÊµã',
        'ÂØªÊâæÈòüÂèã',
        'ÊäÄÊúØ‰∫§ÊµÅ',
        'Ê∏∏ÊàèËµÑËÆØ',
        'ÂÖ∂‰ªñ',
    ];

    // ÁÉ≠Èó®Ê†áÁ≠æ
    const popularTags = [
        'ÂéüÁ•û', 'ÁéãËÄÖËç£ËÄÄ', 'Ëã±ÈõÑËÅîÁõü', 'CS2', 'APEX',
        'Ê∞∏Âä´Êó†Èó¥', 'ÂçöÂæ∑‰πãÈó®3', 'ÈªëÁ•ûËØùÊÇüÁ©∫', 'ËâæÂ∞îÁôªÊ≥ïÁéØ',
        'Steam', 'Epic', 'Áã¨Á´ãÊ∏∏Êàè', '3AÂ§ß‰Ωú', 'RPG',
        'FPS', 'MOBA', 'ÂºÄÊîæ‰∏ñÁïå', 'ÊÅêÊÄñÊ∏∏Êàè', 'ÁîüÂ≠òÊ∏∏Êàè',
    ];

    // Êèê‰∫§Â∏ñÂ≠ê
    const handleSubmit = async (values: any) => {
        try {
            setLoading(true);

            const postData: CreatePostRequest = {
                title: values.title,
                body: content || values.content,
            };

            const newPost = await PostsApi.createPost(postData);

            message.success('ÂèëÂ∏ÉÊàêÂäüÔºÅ');

            // Ë∑≥ËΩ¨Âà∞Â∏ñÂ≠êËØ¶ÊÉÖÈ°µ
            setTimeout(() => {
                router.push(`/post/${newPost.postId}`);
            }, 500);
        } catch (error: any) {
            message.error(error.message || 'ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
        } finally {
            setLoading(false);
        }
    };

    // ‰øùÂ≠òËçâÁ®ø
    const handleSaveDraft = () => {
        const values = form.getFieldsValue();
        localStorage.setItem('post_draft', JSON.stringify({
            ...values,
            content,
            tags: selectedTags,
            savedAt: new Date().toISOString(),
        }));
        message.success('ËçâÁ®øÂ∑≤‰øùÂ≠ò');
    };

    // Âä†ËΩΩËçâÁ®ø
    const loadDraft = () => {
        const draft = localStorage.getItem('post_draft');
        if (draft) {
            try {
                const draftData = JSON.parse(draft);
                form.setFieldsValue(draftData);
                setContent(draftData.content || '');
                setSelectedTags(draftData.tags || []);
                message.info(`Â∑≤Âä†ËΩΩ ${new Date(draftData.savedAt).toLocaleString()} ÁöÑËçâÁ®ø`);
            } catch (error) {
                message.error('ËçâÁ®øÂä†ËΩΩÂ§±Ë¥•');
            }
        }
    };

    // Ê∏ÖÈô§ËçâÁ®ø
    const clearDraft = () => {
        localStorage.removeItem('post_draft');
        form.resetFields();
        setContent('');
        setSelectedTags([]);
        message.success('ËçâÁ®øÂ∑≤Ê∏ÖÈô§');
    };

    // ÊèíÂÖ•Ê†ºÂºèÂåñÊñáÊú¨
    const insertFormat = (format: string) => {
        const textarea = document.querySelector('textarea') as HTMLTextAreaElement;
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = content.substring(start, end);
        let newText = '';

        switch (format) {
            case 'bold':
                newText = `**${selectedText || 'Á≤ó‰ΩìÊñáÊú¨'}**`;
                break;
            case 'italic':
                newText = `*${selectedText || 'Êñú‰ΩìÊñáÊú¨'}*`;
                break;
            case 'link':
                newText = `[${selectedText || 'ÈìæÊé•ÊñáÊú¨'}](URL)`;
                break;
            case 'image':
                newText = `![${selectedText || 'ÂõæÁâáÊèèËø∞'}](ÂõæÁâáURL)`;
                break;
            case 'ul':
                newText = `\n- ${selectedText || 'ÂàóË°®È°π'}\n`;
                break;
            case 'ol':
                newText = `\n1. ${selectedText || 'ÂàóË°®È°π'}\n`;
                break;
            default:
                newText = selectedText;
        }

        const newContent = content.substring(0, start) + newText + content.substring(end);
        setContent(newContent);
    };

    // Ê†áÁ≠æÈÄâÊã©
    const handleTagSelect = (tag: string) => {
        if (selectedTags.includes(tag)) {
            setSelectedTags(selectedTags.filter(t => t !== tag));
        } else if (selectedTags.length < 5) {
            setSelectedTags([...selectedTags, tag]);
        } else {
            message.warning('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©5‰∏™Ê†áÁ≠æ');
        }
    };

    const darkTheme = {
        algorithm: theme.darkAlgorithm,
        token: {
            colorPrimary: '#FF6B6B',
            colorBgContainer: '#1a1a1a',
            colorBgElevated: '#262626',
            colorBgLayout: '#0d0d0d',
        },
    };

    return (
        <ConfigProvider theme={darkMode ? darkTheme : undefined}>
            <ProLayout
                title="GameVault"
                logo="üéÆ"
                layout="top"
                contentWidth="Fixed"
                fixedHeader
                navTheme={darkMode ? "realDark" : "light"}

            >
                <div style={{
                    minHeight: '100vh',
                    background: darkMode ? '#0d0d0d' : '#f0f2f5',
                    padding: '24px',
                }}>
                    <div style={{ maxWidth: 1000, margin: '0 auto' }}>
                        {/* È°µÈù¢Ê†áÈ¢ò */}
                        <Card style={{ marginBottom: 24 }}>
                            <Space>
                                <Button
                                    icon={<ArrowLeftOutlined />}
                                    onClick={() => router.back()}
                                >
                                    ËøîÂõû
                                </Button>
                                <Title level={3} style={{ margin: 0 }}>ÂèëÂ∏ÉÊñ∞Â∏ñ</Title>
                            </Space>
                        </Card>

                        {/* ‰∏ªË°®Âçï */}
                        <Form
                            form={form}
                            layout="vertical"
                            onFinish={handleSubmit}
                            autoComplete="off"
                        >
                            <Row gutter={24}>
                                <Col xs={24} lg={16}>
                                    <Card>
                                        <Form.Item
                                            label="Ê†áÈ¢ò"
                                            name="title"
                                            rules={[
                                                { required: true, message: 'ËØ∑ËæìÂÖ•Ê†áÈ¢ò' },
                                                { min: 5, message: 'Ê†áÈ¢òËá≥Â∞ë5‰∏™Â≠óÁ¨¶' },
                                                { max: 100, message: 'Ê†áÈ¢òÊúÄÂ§ö100‰∏™Â≠óÁ¨¶' },
                                            ]}
                                        >
                                            <Input
                                                placeholder="ËØ∑ËæìÂÖ•Â∏ñÂ≠êÊ†áÈ¢ò"
                                                size="large"
                                                showCount
                                                maxLength={100}
                                            />
                                        </Form.Item>

                                        <Form.Item
                                            label={
                                                <Space>
                                                    <span>ÂÜÖÂÆπ</span>
                                                    <Space size="small">
                                                        <Button
                                                            type="text"
                                                            icon={<BoldOutlined />}
                                                            onClick={() => insertFormat('bold')}
                                                        />
                                                        <Button
                                                            type="text"
                                                            icon={<ItalicOutlined />}
                                                            onClick={() => insertFormat('italic')}
                                                        />
                                                        <Button
                                                            type="text"
                                                            icon={<LinkOutlined />}
                                                            onClick={() => insertFormat('link')}
                                                        />
                                                        <Button
                                                            type="text"
                                                            icon={<PictureOutlined />}
                                                            onClick={() => insertFormat('image')}
                                                        />
                                                        <Button
                                                            type="text"
                                                            icon={<UnorderedListOutlined />}
                                                            onClick={() => insertFormat('ul')}
                                                        />
                                                        <Button
                                                            type="text"
                                                            icon={<OrderedListOutlined />}
                                                            onClick={() => insertFormat('ol')}
                                                        />
                                                    </Space>
                                                </Space>
                                            }
                                            name="content"
                                            rules={[
                                                { required: true, message: 'ËØ∑ËæìÂÖ•ÂÜÖÂÆπ' },
                                                { min: 20, message: 'ÂÜÖÂÆπËá≥Â∞ë20‰∏™Â≠óÁ¨¶' },
                                            ]}
                                        >
                                            <TextArea
                                                value={content}
                                                onChange={(e) => setContent(e.target.value)}
                                                placeholder="ËØ∑ËæìÂÖ•Â∏ñÂ≠êÂÜÖÂÆπÔºåÊîØÊåÅ Markdown Ê†ºÂºè"
                                                rows={12}
                                                showCount
                                                maxLength={10000}
                                            />
                                        </Form.Item>

                                        <Form.Item label="‰∏ä‰º†ÂõæÁâá">
                                            <Upload
                                                listType="picture-card"
                                                maxCount={9}
                                                beforeUpload={() => false}
                                            >
                                                <div>
                                                    <UploadOutlined />
                                                    <div style={{ marginTop: 8 }}>‰∏ä‰º†ÂõæÁâá</div>
                                                </div>
                                            </Upload>
                                            <Text type="secondary">ÊúÄÂ§ö‰∏ä‰º†9Âº†ÂõæÁâáÔºåÂçïÂº†‰∏çË∂ÖËøá5MB</Text>
                                        </Form.Item>
                                    </Card>
                                </Col>

                                <Col xs={24} lg={8}>
                                    {/* ÂàÜÁ±ªÂíåÊ†áÁ≠æ */}
                                    <Card style={{ marginBottom: 16 }}>
                                        <Form.Item
                                            label="ÂàÜÁ±ª"
                                            name="category"
                                            rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©ÂàÜÁ±ª' }]}
                                        >
                                            <Select placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª" size="large">
                                                {categories.map(cat => (
                                                    <Option key={cat} value={cat}>{cat}</Option>
                                                ))}
                                            </Select>
                                        </Form.Item>

                                        <Form.Item label="Ê†áÁ≠æ">
                                            <div style={{ marginBottom: 8 }}>
                                                <Text type="secondary">Â∑≤ÈÄâÊã© {selectedTags.length}/5 ‰∏™Ê†áÁ≠æ</Text>
                                            </div>
                                            <Space wrap>
                                                {selectedTags.map(tag => (
                                                    <Tag
                                                        key={tag}
                                                        color="blue"
                                                        closable
                                                        onClose={() => handleTagSelect(tag)}
                                                    >
                                                        {tag}
                                                    </Tag>
                                                ))}
                                            </Space>
                                            <div style={{ marginTop: 12 }}>
                                                <Text type="secondary">ÁÉ≠Èó®Ê†áÁ≠æÔºö</Text>
                                                <div style={{ marginTop: 8 }}>
                                                    <Space wrap size={[0, 8]}>
                                                        {popularTags.map(tag => (
                                                            <Tag
                                                                key={tag}
                                                                style={{ cursor: 'pointer' }}
                                                                color={selectedTags.includes(tag) ? 'blue' : 'default'}
                                                                onClick={() => handleTagSelect(tag)}
                                                            >
                                                                {tag}
                                                            </Tag>
                                                        ))}
                                                    </Space>
                                                </div>
                                            </div>
                                        </Form.Item>
                                    </Card>

                                    {/* Êìç‰ΩúÊåâÈíÆ */}
                                    <Card>
                                        <Space direction="vertical" style={{ width: '100%' }}>
                                            <Button
                                                type="primary"
                                                htmlType="submit"
                                                block
                                                size="large"
                                                loading={loading}
                                                style={{
                                                    background: 'linear-gradient(90deg, #FF6B6B 0%, #4ECDC4 100%)',
                                                }}
                                            >
                                                ÂèëÂ∏ÉÂ∏ñÂ≠ê
                                            </Button>

                                            <Button
                                                block
                                                size="large"
                                                onClick={handleSaveDraft}
                                            >
                                                ‰øùÂ≠òËçâÁ®ø
                                            </Button>

                                            <Button
                                                block
                                                onClick={() => setPreviewMode(!previewMode)}
                                            >
                                                {previewMode ? 'ÁºñËæë' : 'È¢ÑËßà'}
                                            </Button>

                                            <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                                                <Button type="link" onClick={loadDraft}>
                                                    Âä†ËΩΩËçâÁ®ø
                                                </Button>
                                                <Button type="link" danger onClick={clearDraft}>
                                                    Ê∏ÖÈô§ËçâÁ®ø
                                                </Button>
                                            </Space>
                                        </Space>
                                    </Card>

                                    {/* ÂèëÂ∏ñÊèêÁ§∫ */}
                                    <Card style={{ marginTop: 16 }}>
                                        <Title level={5}>ÂèëÂ∏ñÈ°ªÁü•</Title>
                                        <Paragraph type="secondary">
                                            <ul style={{ paddingLeft: 20, margin: 0 }}>
                                                <li>ËØ∑ÈÅµÂÆàÁ§æÂå∫ËßÑËåÉÔºåÊñáÊòéÂèëË®Ä</li>
                                                <li>‰∏çÂæóÂèëÂ∏ÉËøùÊ≥ïËøùËßÑÂÜÖÂÆπ</li>
                                                <li>‰∏çÂæóÂèëÂ∏ÉÂπøÂëäÊàñÂûÉÂúæ‰ø°ÊÅØ</li>
                                                <li>Â∞äÈáç‰ªñ‰∫∫ÔºåÂèãÂñÑ‰∫§ÊµÅ</li>
                                                <li>ÂÜÖÂÆπÊîØÊåÅ Markdown Ê†ºÂºè</li>
                                            </ul>
                                        </Paragraph>
                                    </Card>
                                </Col>
                            </Row>
                        </Form>

                        {/* È¢ÑËßàÊ®°Âºè */}
                        {previewMode && (
                            <Card style={{ marginTop: 24 }}>
                                <Title level={4}>È¢ÑËßà</Title>
                                <Divider />
                                <Title level={3}>{form.getFieldValue('title') || 'Ê†áÈ¢òÈ¢ÑËßà'}</Title>
                                <Paragraph>
                                    {content || 'ÂÜÖÂÆπÈ¢ÑËßà...'}
                                </Paragraph>
                            </Card>
                        )}
                    </div>
                </div>
            </ProLayout>
        </ConfigProvider>
    );
}